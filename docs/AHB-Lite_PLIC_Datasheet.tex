\documentclass[]{article}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}

\usepackage{graphicx,grffile}
\graphicspath{ {../assets/graphics/} }
\usepackage{longtable}

\usepackage{booktabs} % For \toprule, \midrule and \bottomrule
\usepackage{csvsimple}

\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=blue,
}
 
\urlstyle{same}

\setlength{\parindent}{0.5em}
\setlength{\parskip}{0.5em}



\title{AHB-Lite Platform Level Interrupt Controller}
\author{Roa Logic}
\date{}

\begin{document}
\begin{figure}
\centering
\includegraphics{../assets/graphics/RoaLogicLogo.png}
\caption{}
\end{figure}

\maketitle
\newpage
\tableofcontents
\newpage


\section{AHB-Lite PLIC Datasheet}

The Roa Logic AHB-Lite PLIC (Platform Level Interrupt Controller) IP is a fully parameterized soft IP implementing a Interrupt Controller as specified by the \emph{\href{https://people.eecs.berkeley.edu/\%7Ekrste/papers/riscv-privileged-v1.9.1.pdf}{RISC-V Privileged 1.9.1 specification}}.

The IP features an AHB-Lite Slave interface, with all signals defined in the \emph{\href{https://www.arm.com/products/system-ip/amba-specifications}{AMBA 3 AHB-Lite v1.0}} specifications fully supported. Bus address \& data widths as well as the number of Interrupt Sources and Targets supported are specified via parameters.

The controller further supports user defined priority levels and pending events, in addition to interrupt masking via programmable priority thresholds

\begin{figure}[h]
\centering
\includegraphics{../assets/graphics/AHB-Lite_PLIC_Port_Diagram.png}
\caption{PLIC Port Diagram}
\end{figure}

\subsection{Features}

\begin{itemize}
\item
  AHB-Lite Interface with programmable address and data width
\item
  User defined number of Interrupt Sources \& Targets
\item
  User defined priority level per Interrupt Source
\item
  Interrupt masking per target via Priority Threshold support
\item
  User defined Interrupt Pending queue depth per source
\end{itemize}

\section{Specifications}

\subsection{Functional Description}

The AHB-Lite PLIC IP is a fully parameterised Platform-Level Interrupt
Controller, featuring a single AHB-Lite Slave interface and interfaces
to a user-defined number of both Interrupt Sources and Targets.

The purpose of the PLIC core is to connect multiple interrupt sources to
one or more interrupt targets. The core supports a programmable number
of simultaneous pending interrupt requests per source and routing of
those interrupt requests to individual targets.

Per the
\href{https://people.eecs.berkeley.edu/%7Ekrste/papers/riscv-privileged-v1.9.1.pdf}{RISC-V
Privileged Architecture Instruction Set specification (v1.9.1)}, the
core performs full interrupt prioritisation of each interrupt source;
each may be assigned a separate priority and enabled per target via a
matrix of interrupt enable bits. Further, an optional threshold per
target may be defined to mask lower priority interrupts.

To reduce latency, the PLIC core presents all asserted interrupts to the
target in priority order, queuing them so that a software interrupt
handler can service all interrupts without the need to restore the
interrupted context.

An example use of the PLIC core is shown below:

\begin{figure}[h]
\centering
\includegraphics{../assets/graphics/AHB-Lite_PLIC_System_Diagram.png}
\caption{PLIC System Diagram}
\end{figure}

\subsection{Interrupt Handling Handshake}

The Roa Logic implementation of the handshake between Interrupt source,
target and PLIC is illustrated below, and described in further detail in
the following sections:

\begin{figure}[h]
\centering
\includegraphics{../assets/graphics/AHB-Lite_PLIC_Handshake.png}
\caption{}
\end{figure}

\subsubsection{PLIC Configuration}

\paragraph{}

A matrix of Interrupt Enable vectors -- one IE register per target --
determines which target processes the interrupts of which source.

Each Interrupt Source attached to the PLIC is then assigned a Priority
Level -- an unsigned integer that determines the relative priority of
the interrupt source. The greater the integer, the greater the priority
level. A Priority Threshold per target may also be defined to mask lower
priority interrupts such that interrupts will only be presented to a
target if the assigned Priority Level Priority Threshold

In addition each source is assigned an Interrupt Identifier
(\texttt{ID}) -- an unique unsigned integer. This identifier determines
interrupt priority when 2 or more interrupts with the same priority
level are asserted. The lower the \texttt{ID} assigned to the source,
the greater the interrupt priority.

\subsubsection{Interrupt Request}

A source asserts an interrupt request to the PLIC. The PLIC validates
the request by first checking if an interrupt enable bit is set for each
target and if the priority of the interrupt source exceeds any defined
Interrupt Priority Threshold. If these conditions do not hold, the
Interrupt Request is deemed invalid and ignored.

The PLIC also determines if a previous interrupt request has been made
by the same source. If an interrupt is defined as level triggered and
has already been asserted but not yet serviced, the request is ignored.
If an interrupt is defined as edge triggered and has already been
asserted but not yet serviced, the request is queued by incrementing a
Interrupt Pending counter by one. The depth of this counter is
programmable.

If the request is deemed valid the request is forwarded to the
appropriate target. In the case of queued edge-triggered requests, the
interrupt pending counter is decremented by one.

\subsubsection{Interrupt Notification}

A target is notified of an interrupt request by the assertion of the IRQ
output for the relevant target. The PLIC also blocks the forwarding of
any further requests from the interrupt source until the asserted
request is serviced.

On each clock cycle the ID register is loaded with the unique identifier
of the highest priority interrupt to be processed.

\subsubsection{Claim Response} \label{sec:claim-response}

A target makes an interrupt claim response by reading the ID register,
which also notifies the target of the interrupt source to service. The
PLIC de-asserts the IRQ output for the target in response to the claim.

\subsubsection{Interrupt Handler}

If the ID read is greater than zero, the target services the identified
interrupt source. If the ID read is zero, this indicates no outstanding
pending interrupts remain and the handler may terminate.

\subsubsection{Interrupt Completion}

Once an interrupt has been serviced, completion is signalled to the PLIC
by writing to the ID register. The act of writing to the register is the
completion notification; the value written is irrelevant.

On receiving the completion notification the PLIC will again allow
interrupts to be forwarded from the corresponding source.

The Interrupt Handler may then exit, however it is possible a new
interrupt request may have been asserted while the handler was running.
To reduce latency the handler may instead determine is a new interrupt
has been received and if so again claim the interrupt as described in
section \emph{\ref{sec:claim-response} \nameref{sec:claim-response}}. In this
way the interrupt handler can service all interrupts without the need to
restore the interrupted context.

\section{Configurations}

\subsection{Core Parameters}

The size and implementation style of the PLIC module is defined via HDL
parameters as specified below:

\begin{longtable}[]{@{}lccl@{}}
\toprule
\textbf{Parameter} & \textbf{Type} & \textbf{Default} & \textbf{Description}\tabularnewline
\midrule
\endhead
\textbf{AHB Interface:} & & &\tabularnewline
\texttt{HADDR\_SIZE} & Integer & 32 & Width of AHB Address Bus\tabularnewline
\texttt{HDATA\_SIZE} & Integer & 32 & Width of AHB Data Buses\tabularnewline
& & &\tabularnewline
\textbf{PLIC Configuration:} & & &\tabularnewline
\texttt{SOURCES} & Integer & 16 & Number of Interrupt Sources\tabularnewline
\texttt{TARGETS} & Integer & 4 & Number of Interrupt Targets\tabularnewline
\texttt{PRIORITIES} & Integer & 8 & Number of Priority Levels\tabularnewline
\texttt{MAX\_PENDING\_COUNT} & Integer & 8 & Max number of pending events\tabularnewline
\texttt{HAS\_THRESHOLD} & Integer & 1 & Is Threshold Implemented\tabularnewline
\texttt{HAS\_CONFIG\_REG} & Integer & 1 & Is Config Reg. Implemented\tabularnewline
\bottomrule
\caption{Core Parameters}
\label{tab:CoreParams}
\end{longtable}


\subsubsection{HADDR\_SIZE}

The \texttt{HADDR\_SIZE} parameter specifies the address bus size to
connect to the AHB-Lite based host. Valid values are 32 and 64. The
default value is 32.

\subsubsection{HDATA\_SIZE}

The \texttt{HDATA\_SIZE} parameter specifies the data bus size to
connect to the AHB-Lite based host. Valid values are 32 and 64. The
default value is 32

\hypertarget{SOURCES}{\subsubsection{SRCES}\label{sec:SOURCES}}

The \texttt{SOURCES} parameter defines the number of individual
interrupt sources supported by the PLIC IP. The default value is 16. The
minimum value is 1.

\hypertarget{TARGETS}{\subsubsection{TARGETS}\label{sec:TARGETS}}

The \texttt{TARGETS} parameter defines the number of targets supported
by the PLIC IP. The default value is 4. The minimum value is 1.

\subsubsection{PRIORITIES}

\sloppy
The PLIC IP supports prioritisation of individual interrupt sources. The \texttt{PRIORITIES} parameter defines the number of priority levels supported by the PLIC IP. The default value is 8. The minimum value is 1.

\subsubsection{MAX\_PENDING\_COUNT}

\sloppy
The PLIC module supports multiple concurrently arriving interrupt
requests. The maximum number of requests that are supported is defined
by the \texttt{MAX\_PENDING\_COUNT} parameter.

The default value is 8. The minimum value is 0.

\subsubsection{HAS\_THRESHOLD}

The PLIC module supports interrupt thresholds -- the masking of
individual interrupt sources based on their priority level. The
\texttt{HAS\_THRESHOLD} parameter defines if this capability is enabled.

The default value is enabled (`1'). To disable, this parameter should be
set to `0'.

\subsubsection{HAS\_CONFIG\_REG}

The PLIC module supports a programmable Configuration Register, which is
documented in section 0. The \texttt{HAS\_CONFIG\_REG} parameter defines
if this capability is enabled.

The default value is enabled (`1'). To disable this parameter should be
set to `0'.

\section{Interfaces}

\subsection{AHB-Lite Interface}

The AHB-Lite interface is a regular AHB-Lite slave port. All signals are
supported. See the
\emph{\href{https://www.arm.com/products/system-ip/amba-specifications}{AMBA
3 AHB-Lite Specification}} for a complete description of the signals.

\begin{longtable}[]{@{}lccl@{}}
\toprule
\textbf{Port} & \textbf{Size} & \textbf{Direction} & \textbf{Description}\tabularnewline
\midrule
\endhead
\texttt{HRESETn} & 1 & Input & Asynchronous active low reset\tabularnewline
\texttt{HCLK} & 1 & Input & Clock Input\tabularnewline
\texttt{HSEL} & 1 & Input & Bus Select\tabularnewline
\texttt{HTRANS} & 2 & Input & Transfer Type\tabularnewline
\texttt{HADDR} & \texttt{HADDR\_SIZE} & Input & Address Bus\tabularnewline
\texttt{HWDATA} & \texttt{HDATA\_SIZE} & Input & Write Data Bus\tabularnewline
\texttt{HRDATA} & \texttt{HDATA\_SIZE} & Output & Read Data Bus\tabularnewline
\texttt{HWRITE} & 1 & Input & Write Select\tabularnewline
\texttt{HSIZE} & 3 & Input & Transfer Size\tabularnewline
\texttt{HBURST} & 3 & Input & Transfer Burst Size\tabularnewline
\texttt{HPROT} & 4 & Input & Transfer Protection Level\tabularnewline
\texttt{HREADYOUT} & 1 & Output & Transfer Ready Output\tabularnewline
\texttt{HREADY} & 1 & Input & Transfer Ready Input\tabularnewline
\texttt{HRESP} & 1 & Output & Transfer Response\tabularnewline
\bottomrule
\caption{AHB Interface Signals}
\label{tab:AHBIF}
\end{longtable}

\subsubsection{HRESETn}

When the active low asynchronous \texttt{HRESETn} input is asserted
(`0'), the interface is put into its initial reset state.

\subsubsection{HCLK}

\texttt{HCLK} is the interface system clock. All internal logic for the
AMB3-Lite interface operates at the rising edge of this system clock and
AHB bus timings are related to the rising edge of \texttt{HCLK}.

\subsubsection{HSEL}

The AHB-Lite interface only responds to other signals on its bus -- with
the exception of the global asynchronous reset signal \texttt{HRESETn}
-- when \texttt{HSEL} is asserted (`1'). When \texttt{HSEL} is negated
(`0') the interface considers the bus \texttt{IDLE}.

\subsubsection{HTRANS}

HTRANS indicates the type of the current transfer.

\begin{longtable}[]{@{}ccp{7cm}@{}}
\toprule
\textbf{HTRANS} & \textbf{Type} & \textbf{Description}\tabularnewline
\midrule
\endhead
00 & \texttt{IDLE} & No transfer required\tabularnewline
01 & \texttt{BUSY} & Connected master is not ready to accept data, but intents to continue the current burst.\tabularnewline
10 & \texttt{NONSEQ} & First transfer of a burst or a single transfer\tabularnewline
11 & \texttt{SEQ} & Remaining transfers of a burst\tabularnewline
\bottomrule
\caption{HTRANS Transfer Types}
\label{table:HTRANS}
\end{longtable}

\subsubsection{HADDR}

\texttt{HADDR} is the address bus. Its size is determined by the
\texttt{HADDR\_SIZE} parameter and is driven to the connected
peripheral.

\subsubsection{HWDATA}

\texttt{HWDATA} is the write data bus. Its size is determined by the
\texttt{HDATA\_SIZE} parameter and is driven to the connected
peripheral.

\subsubsection{HRDATA}

\texttt{HRDATA} is the read data bus. Its size is determined by
\texttt{HDATA\_SIZE} parameter and is sourced by the APB4 peripheral.

\subsubsection{HWRITE}

\texttt{HWRITE} is the read/write signal. \texttt{HWRITE} asserted (`1')
indicates a write transfer.

\subsubsection{HSIZE}

\texttt{HSIZE} indicates the size of the current transfer.

\begin{longtable}[]{@{}ccl@{}}
\toprule
\textbf{HSIZE} & \textbf{Size} & \textbf{Description}\tabularnewline
\midrule
\endhead
000 & 8 bit & Byte\tabularnewline
001 & 16 bit & Half Word\tabularnewline
010 & 32 bit & Word\tabularnewline
011 & 64 bits & Double Word\tabularnewline
100 & 128 bit &\tabularnewline
101 & 256 bit &\tabularnewline
110 & 512 bit &\tabularnewline
111 & 1024 bit &\tabularnewline
\bottomrule
\caption{HSIZE Values}
\label{tab:HSIZE}
\end{longtable}

\subsubsection{HBURST}

HBURST indicates the transaction burst type -- a single transfer or part
of a burst.

\begin{longtable}[]{@{}ccl@{}}
\toprule
\textbf{HBURST} & \textbf{Type} & \textbf{Description}\tabularnewline
\midrule
\endhead
000 & \texttt{SINGLE} & Single access**\tabularnewline
001 & \texttt{INCR} & Continuous incremental burst\tabularnewline
010 & \texttt{WRAP4} & 4-beat wrapping burst\tabularnewline
011 & \texttt{INCR4} & 4-beat incrementing burst\tabularnewline
100 & \texttt{WRAP8} & 8-beat wrapping burst\tabularnewline
101 & \texttt{INCR8} & 8-beat incrementing burst\tabularnewline
110 & \texttt{WRAP16} & 16-beat wrapping burst\tabularnewline
111 & \texttt{INCR16} & 16-beat incrementing burst\tabularnewline
\bottomrule
\caption{HBURST Types}
\label{tab:HBURST}
\end{longtable}

\subsubsection{HPROT}

The \texttt{HPROT} signals provide additional information about the bus
transfer and are intended to implement a level of protection.

\begin{longtable}[]{@{}ccl@{}}
\toprule
\textbf{Bit\#} & \textbf{Value} & \textbf{Description}\tabularnewline
\midrule
\endhead
3 & 1 & Cacheable region addressed\tabularnewline
& 0 & Non-cacheable region addressed\tabularnewline
2 & 1 & Bufferable\tabularnewline
& 0 & Non-bufferable\tabularnewline
1 & 1 & Privileged Access\tabularnewline
& 0 & User Access\tabularnewline
0 & 1 & Data Access\tabularnewline
& 0 & Opcode fetch\tabularnewline
\bottomrule
\caption{HPROT Indicators}
\label{tab:HPROT}
\end{longtable}

\subsubsection{HREADYOUT}

\texttt{HREADYOUT} indicates that the current transfer has finished.
Note, for the AHB-Lite PLIC this signal is constantly asserted as the
core is always ready for data access.

\subsubsection{HREADY}

\texttt{HREADY} indicates whether or not the addressed peripheral is
ready to transfer data. When \texttt{HREADY} is negated (`0') the
peripheral is not ready, forcing wait states. When \texttt{HREADY} is
asserted (`1') the peripheral is ready and the transfer completed.

\subsubsection{HRESP}

\texttt{HRESP} is the instruction transfer response and indicates OKAY
(`0') or ERROR (`1').

\subsection{PLIC Interface}

Blah

\begin{longtable}[]{@{}cccl@{}}
\toprule
\textbf{Port} & \textbf{Size} & \textbf{Direction} &
\textbf{Description}\tabularnewline
\midrule
\endhead
\texttt{SRC} & \texttt{SOURCES} & Input & Interrupt
Sources\tabularnewline
\texttt{IRQ} & \texttt{TARGETS} & Output & Interrupt
Requests\tabularnewline
\bottomrule
\caption{PLIC Interface Signals}
\label{tab:PLICIF}
\end{longtable}

Note: Width of PLIC interface buses defined by
\protect\hyperlink{core-parameters}{Core Parameters}.

\subsubsection{SRC}

Interrupt sources connect to the \texttt{SRC{[}SOURCES-1..0{]}} input of
the PLIC module. The width of this interface is defined by the
\protect\hyperlink{SOURCES}{\texttt{SOURCES}} parameter.

\subsubsection{IRQ}

Interrupt targets are sourced by the \texttt{IRQ{[}TARGETS-1..0{]}}
output of the PLIC module. The width of this interface is defined by the
\protect\hyperlink{TARGETS}{\texttt{TARGETS}} parameter.

\subsection{Register Interface}

The following registers are user accessible in the PLIC module:

\begin{longtable}[]{@{}ccccp{3cm}@{}}
\toprule
\textbf{Register} & \textbf{Registers} & \textbf{Width (bits)} & \textbf{Mode} & \textbf{Function}\tabularnewline
\midrule
\endhead
\texttt{CONFIG} & 1 & 64 & RO & Configuration\tabularnewline
\texttt{EL} & 1 & \texttt{SOURCES} & RW & Edge/Level Trigger\tabularnewline
\texttt{IE} & \texttt{TARGETS} & \texttt{SOURCES} & RW & Interrupt Enable\tabularnewline
\texttt{ID} & \texttt{TARGETS} & clog\textsubscript{2}(\texttt{SOURCES}) & RW & ID of Highest priority IRQ, Int. Claim (R), Int. Complete (W)\tabularnewline
\texttt{PRIORITY} & \texttt{SOURCES} & clog\textsubscript{2}(\texttt{PRIORITIES}) & RW & Priority Level\tabularnewline
\texttt{THRESHOLD} & \texttt{TARGETS} & clog\textsubscript{2}(\texttt{PRIORITIES}) & RW & Priority Threshold\tabularnewline
\bottomrule
\caption{PLIC Register Interface}
\label{tab:REGIF}
\end{longtable}

Note: clog\textsubscript{2}() refers to the System Verilog function by
the same name, defined as:

\begin{quote}
\emph{The system function \$clog2 shall return the ceiling of the log
base 2 of the argument (the log rounded up to an integer value). The
argument can be an integer or an arbitrary sized vector value. The
argument shall be treated as an unsigned value, and an argument value of
0 shall produce a result of 0.}
\end{quote}

\subsubsection{CONFIG}

The \texttt{CONFIG} register is a Read-Only register that enables a
software routine to determine the hardware configuration of the PLIC
module.

When enabled via the \texttt{HAS\_CONFIG\_REG} hardware parameter, the
\texttt{CONFIG} register returns a 64 bit value constructed as follows:

\begin{longtable}[]{@{}llllllllllllll@{}}
\toprule
Bit Position & 63 & & 49 & 48 & 47 & & 32 & 31 & & 16 & 15 & &
0\tabularnewline
\midrule
\endhead
Value & 0 & HAS\_THRESHOLD & PRIORITIES & TARGETS & SOURCES & & & & & &
& &\tabularnewline
\bottomrule
\end{longtable}

The values, \texttt{HAS\_THRESHOLD}, \texttt{PRIORITIES},
\texttt{TARGETS} and \texttt{SOURCES} correspond to the hardware
parameters documented in section 3.1.

\subsubsection{EL}

The \texttt{EL} Read/Write register defines if an interrupt source is
Edge or Level Triggered.

The number of interrupt sources, as defined by the
\protect\hyperlink{SOURCES}{\texttt{SOURCES}} parameter, determines
the width of the \texttt{EL} register. One bit within the register
corresponds to an interrupt source, where a logic high (`1') defines a
rising-edge triggered interrupt and a logic low (`0') defines a level
triggered interrupt.

\subsubsection{IE[]}

The matrix of \texttt{IE[]} Read/Write registers define if an
interrupt source is enabled or disabled for a specific target. When
disabled, any interrupts generated by the source will be ignored by the
PLIC.

The number of targets determines the number of \texttt{IE[]}
registers. The number of interrupt sources, as defined by the
\protect\hyperlink{SOURCES}{\texttt{SOURCES}} parameter, determines the
width of each \texttt{IE[]} register. One bit within the register
corresponds to an individual interrupt source, where a logic high (`1')
defines an interrupt source as enabled and a logic low (`0') as
disabled.

\subsubsection{ID[]}

The \texttt{ID[]} Read/Write register identifies to each target
the ID of the highest priority pending interrupt request.

This register indicates to the target which of potentially multiple
pending interrupts should be serviced rather than relying on this being
resolved by the software Interrupt Service Routine.

When a target reads this register, this also indicates the target has
claimed the interrupt for the defined source and will service then
service the interrupt source.

A target then writes to this register to indicate completion of
servicing the interrupt source. It is the action of writing to this
register which generates the interrupt completion notification -- the
value written will not update the register which continues to identify
the highest priority interrupt source to be serviced.

\subsubsection{PRIORITY[]}

The \texttt{PRIORITY[]} Read/Write
registers define the priority level of each interrupt source.

There is one \texttt{PRIORITY[]}
register per interrupt source as defined by the \texttt{SOURCES}
parameter (see \protect\hyperlink{SOURCES}{\texttt{SOURCES}}), identified as
\texttt{PRIORITY[SOURCES-1:0]}. The
width of each register is derived from the number of priority levels as
defined by the \texttt{PRIORITIES} parameter (see
\protect\hyperlink{TARGETS}{\texttt{TARGETS}}).

Interrupt priority increases with larger values of \texttt{PRIORITY}.

\subsubsection{THRESHOLD[]}

Each target may be assigned a priority threshold via the
\texttt{THRESHOLD[]} registers. Only
active interrupts that have a priority strictly greater than the
threshold will cause an interrupt notification to be sent to the target.
A \texttt{THRESHOLD[]} value of 0
means that no interrupts will be masked.

\subsection{Register Address Mapping}

The PLIC supports a wide variety of options and unlimited user-definable
number of both interrupt sources and targets. To configure and control
the PLIC requires a memory-mapped register interface that must be
defined according to the specific implementation.

To ease the development of PLIC based systems, the Roa Logic PLIC
implements a dynamic register interface based on the hardware parameters
set during generation of the implementation, packing multiple bit-fields
into registers where feasible to minimise the required address space.

The following sections describe the calculations performed during
generation of the dynamic register interface so that the user may
determine the registers available and the memory mapping of those
registers for a given implementation.

A spreadsheet in Microsoft Excel format is available to perform these
calculations based on user-defined parameters to show the registers and
memory mapping. Further, simulation of the PLIC will also shows the
registers and memory mapping.

\subsubsection{Itemising Register Requirements}

The section "\protect\hyperlink{register-interface}{Register Interface}"
provides a summary of the registers required to control and configure
the PLIC. The following is a more detailed summary of those
requirements.

\paragraph{CONFIG Register}

The \texttt{CONFIG} register is always 64 bits. For 32 bit
implementations this means 2 physical registers are required, 1 each for
the upper and lower word. For 64 bit implementations a single register
will be implemented.

\paragraph{EL Registers}

Each interrupt source requires a single bit in the \texttt{EL} register
to define if the source is level or edge triggered. These bits will be
packed into the minimum number of registers.

The physical number of registers implemented can be calculated as
follows:

\begin{quote}
\texttt{No.\ of\ Registers\ =\ ROUNDUP(SOURCES/HDATA\_SIZE)}
\end{quote}

Example: For a 32 bit system supporting 48 interrupt sources

\begin{verbatim}
No. of Registers = ROUNDUP(SOURCES/HDATA_SIZE)   
                 = ROUNDUP(48/32)
                 = ROUNDUP(1.5)
                 = 2
\end{verbatim}

\paragraph{IE Registers}

Interrupt sources may be enabled or disabled per target requiring single
bit per target. These bits will be packed into the fewest registers
possible and the resulting number of registers calculated as follows:

\begin{quote}
\texttt{No.\ of\ Registers\ =\ ROUNDUP(SOURCES/HDATA\_SIZE)*TARGETS}
\end{quote}

Example: For a 32 bit system supporting 48 interrupt sources and 4
targets

\begin{verbatim}
No. of Registers = ROUNDUP(SOURCES/HDATA_SIZE)*TARGETS
                 = ROUNDUP(48/32)*4
                 = ROUNDUP(1.5)*4
                 = 2*4
                 = 8
\end{verbatim}

\paragraph{ID Registers}

The \texttt{ID[]} Read/Write
register identifies the ID of the highest priority pending interrupt
request, with one ID register required per target.

\begin{quote}
\texttt{No.\ of\ Registers\ =\ TARGETS}
\end{quote}

\paragraph{Priority Registers}

Each interrupt source can be assigned a priority, which is defined as
positive integer. The PLIC parameter \texttt{PRIORITIES} defines the
number of priority levels for a specific implementation, which then
allows a source to be assigned a priority between 1 and
\texttt{PRIORITIES}.

These priority levels are packed into
\texttt{HDATA\_SIZE} bit registers, as fields aligned to
4-bit nibble boundaries

\begin{quote}
\texttt{No.\ of\ Registers\ =\ ROUNDUP(SOURCES/FPR)}
\end{quote}

where:

\begin{verbatim}
FPR = FIELDS_PER_REGISTER
    = HDATA_SIZE/(4*NPP)

NPP = NIBBLES_PER_PRIORITY
    = ROUNDUP($clog2(PRIORITIES+1)/4)
\end{verbatim}

Example: For a 32 bit system supporting 48 interrupt sources and 8
priority levels

\begin{verbatim}
NPP = NIBBLES_PER_PRIORITY
    = ROUNDUP($clog2(PRIORITIES+1)/4)
    = ROUNDUP($clog2(8+1)/4)
    = ROUNDUP(4/4)
    = 1

FPR = FIELDS_PER_REGISTER
    = HDATA_SIZE/(4*NPP)
    = 32/(4*1)
    = 8

No. of Registers = ROUNDUP(SOURCES/FPR)
                 = ROUNDUP(48/8)
                 = 6
\end{verbatim}

Note: clog\textsubscript{2}() refers to the System Verilog function by
the same name and calculates the number of binary bits required to
represent a given integer.

\paragraph{Threshold Registers}

Each target may be assigned a priority threshold and therefore the PLIC
implements 1 register per threshold.

\begin{quote}
\texttt{No.\ of\ Registers\ =\ TARGETS}
\end{quote}

\subsubsection{Register Address Map}

The order of the registers in the memory map is defined as follows:

\begin{longtable}[]{@{}cl@{}}
\toprule
\textbf{Order} & \textbf{Registers}\tabularnewline
\midrule
\endhead
1 & CONFIG Register(s)\tabularnewline
2 & EL Registers\tabularnewline
3 & PRIORITY Registers\tabularnewline
4 & IE Registers\tabularnewline
5 & THRESHOLD Registers\tabularnewline
6 & ID Registers\tabularnewline
\bottomrule
\caption{Register Address Order}
\label{tab:REGMAP}
\end{longtable}

Registers a mapped to consecutive addresses based on this order and the
number of registers required.

Using the previous example of a 32 bit system supporting 48 interrupt
sources, 4 targets and 8 priority levels:

\begin{longtable}[]{@{}cc@{}}
\toprule
\textbf{Parameter} & \textbf{Value}\tabularnewline
\midrule
\endhead
HDATA\_WIDTH & 32\tabularnewline
SOURCES & 48\tabularnewline
TARGETS & 4\tabularnewline
PRIORITIES & 8\tabularnewline
\bottomrule
\end{longtable}

The resulting number of registers is:

\begin{longtable}[]{@{}cc@{}}
\toprule
\textbf{Registers} & \textbf{Number}\tabularnewline
\midrule
\endhead
CONFIG & 2\tabularnewline
EL & 2\tabularnewline
PRIORITY & 6\tabularnewline
IE & 8\tabularnewline
THRESHOLD & 4\tabularnewline
ID & 4\tabularnewline
\textbf{Total} & \textbf{26}\tabularnewline
\bottomrule
\end{longtable}

These registers will be then mapped as follows according to the order
defined below:

\begin{longtable}[]{@{}ccc@{}}
\toprule
\textbf{Reg} & \textbf{Parameter} & \textbf{Value}\tabularnewline
\midrule
\endhead
\textbf{0} & 0x0 & CONFIG\tabularnewline
\textbf{1} & 0x4 & CONFIG\tabularnewline
\textbf{2} & 0x8 & EL\tabularnewline
\textbf{3} & 0xC & EL\tabularnewline
\textbf{4} & 0x10 & PRIORITY\tabularnewline
\textbf{5} & 0x14 & PRIORITY\tabularnewline
\textbf{6} & 0x18 & PRIORITY\tabularnewline
\textbf{7} & 0x1C & PRIORITY\tabularnewline
\textbf{8} & 0x20 & PRIORITY\tabularnewline
\textbf{9} & 0x24 & PRIORITY\tabularnewline
\textbf{10} & 0x28 & IE\tabularnewline
\textbf{11} & 0x2C & IE\tabularnewline
\textbf{12} & 0x30 & IE\tabularnewline
\textbf{13} & 0x34 & IE\tabularnewline
\textbf{14} & 0x38 & IE\tabularnewline
\textbf{15} & 0x3C & IE\tabularnewline
\textbf{16} & 0x40 & IE\tabularnewline
\textbf{17} & 0x44 & IE\tabularnewline
\textbf{18} & 0x48 & THRESHOLD\tabularnewline
\textbf{19} & 0x4C & THRESHOLD\tabularnewline
\textbf{20} & 0x50 & THRESHOLD\tabularnewline
\textbf{21} & 0x54 & THRESHOLD\tabularnewline
\textbf{22} & 0x58 & ID\tabularnewline
\textbf{23} & 0x5C & ID\tabularnewline
\textbf{24} & 0x60 & ID\tabularnewline
\textbf{25} & 0x64 & ID\tabularnewline
\bottomrule
\end{longtable}

Note: A spreadsheet exists that can calculate the above Register Address
Mapping and is downloadable from the Roa Logic web site.

\begin{figure}[h]
\centering
\includegraphics{../assets/graphics/AHB-Lite_PLIC_Worksheet.png}
\caption{Register Mapping Worksheet}
\end{figure}

\section{Resources}

Below are some example implementations for various platforms.

All implementations are push button, no effort has been undertaken to
reduce area or improve performance.

\begin{longtable}[]{@{}lllll@{}}
\toprule
\textbf{Platform} & \textbf{DFF} & \textbf{Logic Cells} &
\textbf{Memory} & \textbf{Performance (MHz)}\tabularnewline
\midrule
\endhead
& & & &\tabularnewline
& & & &\tabularnewline
& & & &\tabularnewline
\bottomrule
\caption{Resource Utilisation Examples}
\label{tab:RESOURCES}
\end{longtable}

\section{References}

The PLIC is designed to be compliant with the
\href{https://people.eecs.berkeley.edu/\%7Ekrste/papers/riscv-privileged-v1.9.1.pdf}{RISC-V
Privileged Architecture v1.9.1} and
\href{https://github.com/riscv/riscv-isa-manual/releases/download/riscv-user-2.2/riscv-spec-v2.2.pdf}{RISC-V
User Level ISA v2.2} specifications, as licensed under the Creative
Commons Attribution 4.0 International License:

\begin{quote}
``The RISC-V Instruction Set Manual, Volume I: User-Level ISA, Document
Version 2.2", Editors Andrew Waterman and Krste Asanović,RISC-V
Foundation, May 2017.
\end{quote}

\begin{quote}
``The RISC-VInstruction Set Manual, Volume II: Privileged Architecture,
Version 1.9.1",Editors Andrew Waterman and Krste Asanović, RISC-V
Foundation, November 2016
\end{quote}

\section{Revision History}

\begin{longtable}[]{@{}lll@{}}
\toprule
\textbf{Date} & \textbf{Rev.} & \textbf{Comments}\tabularnewline
\midrule
\endhead
& 1.0 &\tabularnewline
** ** & &\tabularnewline
** ** & &\tabularnewline
** ** & &\tabularnewline
\bottomrule
\caption{Revision History}
\label{tab:REVS}
\end{longtable}

\end{document}
